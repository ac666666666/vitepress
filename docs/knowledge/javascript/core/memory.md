# å†…å­˜ç®¡ç†ä¸åƒåœ¾å›æ”¶

[MDN JavaScript æ–‡æ¡£](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript)

JavaScript çš„å†…å­˜ç®¡ç†æ˜¯è‡ªåŠ¨çš„ï¼Œä½†ç†è§£å…¶æœºåˆ¶å¯¹äºç¼–å†™é«˜æ€§èƒ½ã€æ— æ³„æ¼çš„ä»£ç è‡³å…³é‡è¦ã€‚

## 1. å†…å­˜ç”Ÿå‘½å‘¨æœŸ

1.  **åˆ†é…å†…å­˜**ï¼šå£°æ˜å˜é‡æ—¶è‡ªåŠ¨åˆ†é…ã€‚
2.  **ä½¿ç”¨å†…å­˜**ï¼šè¯»å†™å˜é‡ã€‚
3.  **é‡Šæ”¾å†…å­˜**ï¼šåƒåœ¾å›æ”¶å™¨ (GC) å›æ”¶ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚

### æ ˆå†…å­˜ (Stack) vs å †å†…å­˜ (Heap)

- **æ ˆ (Stack)**: å­˜å‚¨**åŸºæœ¬æ•°æ®ç±»å‹** (Number, String, Boolean, Null, Undefined, Symbol, BigInt) å’Œ **å¼•ç”¨ç±»å‹çš„åœ°å€æŒ‡é’ˆ**ã€‚
  - ç‰¹ç‚¹ï¼šç©ºé—´å°ï¼Œé€Ÿåº¦å¿«ï¼Œç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ã€‚
- **å † (Heap)**: å­˜å‚¨**å¼•ç”¨ç±»å‹** (Object, Array, Function...) çš„**å®ä½“**ã€‚
  - ç‰¹ç‚¹ï¼šç©ºé—´å¤§ï¼Œé€Ÿåº¦æ…¢ï¼Œé€šè¿‡æŒ‡é’ˆè®¿é—®ã€‚

## 2. åƒåœ¾å›æ”¶æœºåˆ¶ (GC)

### 2.1 å¼•ç”¨è®¡æ•° (Reference Counting) - _å·²è¿‡æ—¶_

- **åŸç†**ï¼šè·Ÿè¸ªè®°å½•æ¯ä¸ªå€¼è¢«å¼•ç”¨çš„æ¬¡æ•°ã€‚å¦‚æœä¸€ä¸ªå€¼çš„å¼•ç”¨æ¬¡æ•°å˜ä¸º 0ï¼Œå°±è¡¨ç¤ºè¿™ä¸ªå€¼ä¸å†ç”¨åˆ°äº†ï¼Œå¯ä»¥å›æ”¶ã€‚
- **è‡´å‘½ç¼ºé™·**ï¼š**å¾ªç¯å¼•ç”¨**ã€‚å¦‚æœä¸¤ä¸ªå¯¹è±¡äº’ç›¸å¼•ç”¨ï¼Œä½†ä¸å†è¢«å…¶ä»–ä»»ä½•å¯¹è±¡å¼•ç”¨ï¼Œå®ƒä»¬çš„å¼•ç”¨è®¡æ•°æ°¸è¿œæ˜¯ 1ï¼Œå¯¼è‡´æ— æ³•å›æ”¶ã€‚

```javascript
function cycle() {
  let o1 = {};
  let o2 = {};
  o1.a = o2; // o1 å¼•ç”¨ o2
  o2.a = o1; // o2 å¼•ç”¨ o1

  // å‡½æ•°ç»“æŸåï¼Œo1 å’Œ o2 æœ¬åº”è¢«å›æ”¶
  // ä½†å› ä¸ºäº’ç›¸å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°ä¸ä¸º 0ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
}
```

### 2.2 æ ‡è®°æ¸…é™¤ (Mark-and-Sweep) - _ç°ä»£æ ‡å‡†_

- **åŸç†**ï¼š
  1.  **æ ¹ (Roots)**ï¼šé€šå¸¸æ˜¯ `window` (å…¨å±€å¯¹è±¡) ä»¥åŠå½“å‰æ‰§è¡Œæ ˆä¸­çš„å˜é‡ã€‚
  2.  **æ ‡è®°**ï¼šåƒåœ¾å›æ”¶å™¨ä»æ ¹å¼€å§‹éå†ï¼Œæ‰€æœ‰èƒ½ä»æ ¹**åˆ°è¾¾**çš„å¯¹è±¡ï¼Œéƒ½æ ‡è®°ä¸º**æ´»åŠ¨å¯¹è±¡** (Reachable)ã€‚
  3.  **æ¸…é™¤**ï¼šé‚£äº›æ²¡æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ï¼ˆå³ä»æ ¹å‡ºå‘æ— æ³•åˆ°è¾¾çš„å¯¹è±¡ï¼‰ï¼Œè¢«è§†ä¸º**åƒåœ¾**ï¼Œè¿›è¡Œå›æ”¶ã€‚
- **ä¼˜åŠ¿**ï¼šå®Œç¾è§£å†³äº†å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚åœ¨ä¸Šé¢çš„ `cycle` ä¾‹å­ä¸­ï¼Œå‡½æ•°ç»“æŸåï¼Œ`o1` å’Œ `o2` ä» `window` å‡ºå‘æ— æ³•åˆ°è¾¾ï¼Œå› æ­¤ä¼šè¢«åˆ¤å®šä¸ºåƒåœ¾å¹¶å›æ”¶ã€‚

### 2.3 V8 ä¼˜åŒ–ï¼šåˆ†ä»£å›æ”¶

- **æ–°ç”Ÿä»£ (Young Generation)**ï¼šå­˜æ´»æ—¶é—´çŸ­çš„å¯¹è±¡ã€‚ä½¿ç”¨ **Scavenge ç®—æ³•** (å¤åˆ¶ç®—æ³•)ï¼Œå°†å†…å­˜åˆ†ä¸º From å’Œ To ä¸¤ä¸ªç©ºé—´ï¼Œå­˜æ´»å¯¹è±¡å¤åˆ¶åˆ° Toï¼Œæ¸…ç©º Fromï¼Œé€Ÿåº¦æå¿«ã€‚
- **è€ç”Ÿä»£ (Old Generation)**ï¼šå­˜æ´»æ—¶é—´é•¿æˆ–æ™‹å‡çš„å¯¹è±¡ã€‚ä½¿ç”¨ **æ ‡è®°-æ¸…é™¤ (Mark-Sweep)** å’Œ **æ ‡è®°-æ•´ç† (Mark-Compact)** ç®—æ³•ã€‚

## 3. å¸¸è§å†…å­˜æ³„æ¼åœºæ™¯ä¸æ’æŸ¥

### 3.1 æ„å¤–çš„å…¨å±€å˜é‡

```javascript
function foo() {
  bar = "I am global"; // æ²¡æœ‰å£°æ˜å˜é‡ (æœªç”¨ let/const/var)ï¼Œè‡ªåŠ¨æŒ‚è½½åˆ° window
  this.baz = "I am also global"; // éä¸¥æ ¼æ¨¡å¼ä¸‹ this æŒ‡å‘ window
}
```

**ä¿®å¤**ï¼šä½¿ç”¨ä¸¥æ ¼æ¨¡å¼ `'use strict'`ï¼Œæˆ–æ­£ç¡®å£°æ˜å˜é‡ã€‚

### 3.2 è¢«é—å¿˜çš„å®šæ—¶å™¨

```javascript
const element = document.getElementById("button");
const intervalId = setInterval(() => {
  // å®šæ—¶å™¨å›è°ƒå‡½æ•°æŒæœ‰ element çš„å¼•ç”¨ (é—­åŒ…)
  // å³ä½¿åœ¨ DOM ä¸­åˆ é™¤äº† buttonï¼Œelement ä¹Ÿæ— æ³•è¢«å›æ”¶
  const node = element;
  if (node) {
    node.innerHTML = Date.now();
  }
}, 1000);

// ä¿®å¤ï¼šç»„ä»¶é”€æ¯æˆ–ä¸å†éœ€è¦æ—¶ï¼Œå¿…é¡»æ¸…é™¤å®šæ—¶å™¨
clearInterval(intervalId);
```

### 3.3 è„±ç¦» DOM çš„å¼•ç”¨ (Detached DOM)

è™½ç„¶åœ¨é¡µé¢ä¸Šåˆ é™¤äº†èŠ‚ç‚¹ï¼Œä½† JS å˜é‡è¿˜æŒ‡ç€å®ƒï¼Œå¯¼è‡´æ— æ³•å›æ”¶ã€‚

```javascript
let detachedNodes = [];
function create() {
  const ul = document.createElement("ul");
  for (let i = 0; i < 10; i++) {
    const li = document.createElement("li");
    ul.appendChild(li);
  }
  // è¿™é‡Œçš„ ul è™½ç„¶æ²¡æœ‰æ·»åŠ åˆ° document.body ä¸­ (æˆ–è€…è¢« remove äº†)
  // ä½†å› ä¸ºå®ƒè¢« detachedNodes æ•°ç»„å¼•ç”¨ï¼Œæ‰€ä»¥æ•´ä¸ª ul æ ‘éƒ½æ— æ³•å›æ”¶
  detachedNodes.push(ul);
}
```

**ä¿®å¤**ï¼šä½¿ç”¨å®Œåå°†å˜é‡ç½®ä¸º `null`ï¼Œå¦‚ `detachedNodes = null`ã€‚

### 3.4 é—­åŒ…å¯¼è‡´çš„å†…å­˜æ³„æ¼

é—­åŒ…å…è®¸å‡½æ•°è®¿é—®å…¶å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡ï¼Œè¿™æœ¬èº«æ˜¯ JS å¼ºå¤§çš„ç‰¹æ€§ã€‚ä½†å¦‚æœä¸å½“ä½¿ç”¨ï¼Œä¼šå¯¼è‡´è¿™äº›å˜é‡**ä¸€ç›´å¸¸é©»å†…å­˜**ï¼Œæ— æ³•è¢« GC å›æ”¶ã€‚

#### (1) å…¸å‹æ¡ˆä¾‹ï¼šæ— æ„ä¸­æŒæœ‰å¤§å¯¹è±¡

```javascript
function outer() {
  // ä¸€ä¸ªå ç”¨å†…å­˜å¾ˆå¤§çš„å¯¹è±¡
  const bigData = new Array(1000000).fill("ğŸ”");

  // å³ä½¿ unused æ²¡è¢«ä½¿ç”¨ï¼Œä½†å› ä¸ºä¸ inner å…±äº«äº†è¯æ³•ä½œç”¨åŸŸ
  // æŸäº› JS å¼•æ“å¯èƒ½ä¼šä¸ºäº†é—­åŒ…ä¸Šä¸‹æ–‡è€Œä¿ç•™æ•´ä¸ªä½œç”¨åŸŸé“¾
  const unused = function () {
    if (bigData) console.log("hi");
  };

  return function inner() {
    console.log("I am inner");
  };
}

const fn = outer();
// outer æ‰§è¡Œå®Œäº†ï¼Œä½†è¿”å›çš„ inner å‡½æ•°å¼•ç”¨äº† outer çš„ä½œç”¨åŸŸ
// å¦‚æœ inner ä¸€ç›´å­˜åœ¨ (æ¯”å¦‚æŒ‚åœ¨å…¨å±€æˆ–å®šæ—¶å™¨é‡Œ)ï¼ŒbigData å¯èƒ½å°±æ— æ³•å›æ”¶
```

#### (2) ä¿®å¤æ–¹æ¡ˆ

1.  **æ‰‹åŠ¨ç½®ç©º**ï¼šä¸å†éœ€è¦æ—¶ï¼Œå°†æŒæœ‰é—­åŒ…çš„å˜é‡ç½®ä¸º `null`ã€‚
    ```javascript
    let fn = outer();
    // ä½¿ç”¨å®Œå...
    fn = null; // åˆ‡æ–­å¼•ç”¨ï¼ŒbigData å°±å¯ä»¥è¢«å›æ”¶äº†
    ```
2.  **é¿å…åœ¨é—­åŒ…ä¸­å¼•ç”¨ä¸å¿…è¦çš„å˜é‡**ï¼šä¸è¦åœ¨é—­åŒ…å¤–å±‚å®šä¹‰å·¨å¤§çš„ã€åªç”¨ä¸€æ¬¡çš„æ•°æ®ï¼Œæˆ–è€…ç”¨å®Œåæ‰‹åŠ¨è®¾ä¸º `null`ã€‚

#### (3) å¹¶ä¸æ˜¯æ‰€æœ‰é—­åŒ…éƒ½æ˜¯æ³„æ¼

åªæœ‰å½“**é—­åŒ…é•¿æœŸå­˜åœ¨**ï¼ˆå¦‚æŒ‚åœ¨å…¨å±€ã€äº‹ä»¶ç›‘å¬ã€å®šæ—¶å™¨ï¼‰ä¸”**æŒæœ‰äº†ä¸å†éœ€è¦çš„èµ„æº**æ—¶ï¼Œæ‰å«å†…å­˜æ³„æ¼ã€‚æ­£å¸¸çš„å‡½æ•°è°ƒç”¨äº§ç”Ÿçš„é—­åŒ…ï¼Œæ‰§è¡Œå®Œé”€æ¯ï¼Œæ˜¯ä¸ä¼šæ³„æ¼çš„ã€‚

## 4. æ·±æ‹·è´ä¸æµ…æ‹·è´è¯¦è§£

### 4.1 æµ…æ‹·è´ (Shallow Copy)

åªæ‹·è´å¯¹è±¡çš„ç¬¬ä¸€å±‚å±æ€§ã€‚

- **åŸºæœ¬ç±»å‹**ï¼šæ‹·è´å€¼ã€‚
- **å¼•ç”¨ç±»å‹**ï¼šæ‹·è´**å†…å­˜åœ°å€**ã€‚

è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ ä¿®æ”¹äº†æ–°å¯¹è±¡ä¸­çš„åµŒå¥—å±æ€§ï¼ˆå¼•ç”¨ç±»å‹ï¼‰ï¼Œ**åŸå§‹å¯¹è±¡ä¹Ÿä¼šè·Ÿç€å˜**ï¼Œå› ä¸ºå®ƒä»¬æŒ‡å‘åŒä¸€ä¸ªå†…å­˜åœ°å€ã€‚

#### ä»£ç ç¤ºä¾‹

```javascript
const obj1 = {
  name: "å°æ˜",
  age: 18,
  info: {
    city: "åŒ—äº¬", // åµŒå¥—å¯¹è±¡
  },
};

// ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦å®ç°æµ…æ‹·è´
const obj2 = { ...obj1 };

// 1. ä¿®æ”¹ç¬¬ä¸€å±‚å±æ€§ (åŸºæœ¬ç±»å‹) -> äº’ä¸å½±å“
obj2.name = "å°çº¢";
console.log(obj1.name); // 'å°æ˜' (æœªå˜)

// 2. ä¿®æ”¹åµŒå¥—å±æ€§ (å¼•ç”¨ç±»å‹) -> äº’ç›¸å½±å“ï¼
obj2.info.city = "ä¸Šæµ·";
console.log(obj1.info.city); // 'ä¸Šæµ·' (å˜äº†ï¼)
```

**å…¶ä»–å¸¸è§æµ…æ‹·è´æ–¹æ³•**ï¼š

- `Object.assign({}, obj)`
- æ•°ç»„æ–¹æ³•ï¼š`arr.slice()`, `arr.concat()`, `[...arr]`

### 4.2 æ·±æ‹·è´ (Deep Copy)

é€’å½’æ‹·è´æ‰€æœ‰å±‚çº§ï¼Œæ–°å¯¹è±¡ä¸åŸå¯¹è±¡**å®Œå…¨ç‹¬ç«‹**ï¼Œäº’ä¸å½±å“ã€‚

#### æ–¹æ¡ˆä¸€ï¼šJSON åºåˆ—åŒ– (ä¹ä¸ç‰ˆ)

```javascript
const newObj = JSON.parse(JSON.stringify(oldObj));
```

- **ä¼˜ç‚¹**ï¼šç®€å•ä»£ç å°‘ã€‚
- **ç¼ºç‚¹**ï¼š
  1.  å¿½ç•¥ `undefined`ã€`symbol`ã€`function`ã€‚
  2.  `Date` å¯¹è±¡å˜ä¸ºå­—ç¬¦ä¸²ã€‚
  3.  `RegExp` å˜ä¸ºç©ºå¯¹è±¡ `{}`ã€‚
  4.  æ— æ³•å¤„ç†**å¾ªç¯å¼•ç”¨** (ä¼šæŠ¥é”™)ã€‚

#### æ–¹æ¡ˆäºŒï¼šæ‰‹å†™é€’å½’ (è¿›é˜¶ç‰ˆ)

è§£å†³å¾ªç¯å¼•ç”¨éœ€è¦ç”¨åˆ° `WeakMap`ã€‚

```javascript
function deepClone(target, map = new WeakMap()) {
  // 1. åŸºç¡€ç±»å‹ç›´æ¥è¿”å›
  if (target === null || typeof target !== "object") {
    return target;
  }

  // 2. å¤„ç† Date å’Œ RegExp
  if (target instanceof Date) return new Date(target);
  if (target instanceof RegExp) return new RegExp(target);

  // 3. å¤„ç†å¾ªç¯å¼•ç”¨ (å¦‚æœå·²ç»æ‹·è´è¿‡ï¼Œç›´æ¥è¿”å› map ä¸­çš„å€¼)
  if (map.has(target)) return map.get(target);

  // 4. åˆ›å»ºæ–°å®¹å™¨ (æ•°ç»„æˆ–å¯¹è±¡)
  const cloneTarget = Array.isArray(target) ? [] : {};
  map.set(target, cloneTarget); // å…ˆå­˜è¿›å»ï¼Œé˜²æ­¢é€’å½’è°ƒç”¨æ­»å¾ªç¯

  // 5. é€’å½’æ‹·è´å±æ€§
  for (const key in target) {
    if (target.hasOwnProperty(key)) {
      cloneTarget[key] = deepClone(target[key], map);
    }
  }

  return cloneTarget;
}
```

## 5. åœ¨çº¿æ¼”ç¤ºï¼šæµ…æ‹·è´ vs æ·±æ‹·è´

ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œè§‚å¯Ÿä¿®æ”¹æ‹·è´å¯¹è±¡æ—¶ï¼Œå¯¹åŸå§‹å¯¹è±¡çš„å½±å“ã€‚

<DeepCopyDemo />

### æ¼”ç¤ºè¯´æ˜

1.  **æµ…æ‹·è´**ï¼šä½¿ç”¨ `...` æ‰©å±•è¿ç®—ç¬¦ã€‚ä¿®æ”¹ `info.city` (åµŒå¥—å±æ€§) æ—¶ï¼Œ**åŸå§‹å¯¹è±¡ä¹Ÿä¼šå˜**ï¼Œå› ä¸ºå®ƒä»¬å…±äº«åŒä¸€ä¸ªå†…å­˜åœ°å€ã€‚
2.  **æ·±æ‹·è´**ï¼šä½¿ç”¨ `JSON` åºåˆ—åŒ–ã€‚ä¿®æ”¹ä»»ä½•å±æ€§ï¼ŒåŸå§‹å¯¹è±¡**éƒ½ä¸ä¼šå˜**ï¼Œå› ä¸ºå®ƒä»¬å®Œå…¨ç‹¬ç«‹ã€‚
